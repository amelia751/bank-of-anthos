apiVersion: v1
kind: ConfigMap
metadata:
  name: enhanced-policy-agent-code
data:
  app.py: |
    #!/usr/bin/env python3
    import json
    import logging
    import os
    import requests
    from datetime import datetime, timedelta
    from typing import Dict, List, Any, Optional
    from flask import Flask, request, jsonify

    try:
        import google.generativeai as genai
        GEMINI_AVAILABLE = True
    except ImportError:
        GEMINI_AVAILABLE = False
        logging.warning("Google Generative AI not available - using fallback templates")

    logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(name)s - %(levelname)s - %(message)s')
    logger = logging.getLogger(__name__)

    app = Flask(__name__)

    class PolicyAgent:
        def __init__(self):
            self.mcp_server_url = os.getenv('MCP_SERVER_URL', 'http://mcp-server:8089')
            
            if GEMINI_AVAILABLE:
                api_key = os.getenv('GEMINI_API_KEY', 'demo-key')
                if api_key and api_key != 'demo-key':
                    try:
                        genai.configure(api_key=api_key)
                        self.model = genai.GenerativeModel('gemini-1.5-flash')
                        logger.info("‚úÖ Gemini API initialized with real key")
                    except Exception as e:
                        logger.warning(f"‚ö†Ô∏è Gemini API failed to initialize: {e}")
                        self.model = None
                else:
                    logger.info("üìù Using enhanced fallback templates (no Gemini API key)")
                    self.model = None
            else:
                self.model = None

        def generate_policy_documents(self, application_data):
            try:
                logger.info("üîç Generating policy documents for credit application")
                
                final_terms = application_data.get('final_terms', {})
                user_info = application_data.get('user_info', {})
                arbiter_decision = application_data.get('arbiter_decision', {})
                
                banking_policies = self._get_banking_policies()
                
                documents = {}
                
                documents['credit_card_agreement'] = self._generate_credit_agreement(final_terms, banking_policies)
                documents['terms_and_conditions'] = self._generate_terms_conditions(final_terms, banking_policies)
                documents['privacy_policy'] = self._generate_privacy_policy(banking_policies)
                documents['fee_schedule'] = self._generate_fee_schedule(final_terms)
                documents['application_summary'] = self._generate_application_summary(application_data)
                documents['regulatory_disclosures'] = self._generate_regulatory_disclosures(final_terms, banking_policies)
                
                return {
                    'agent': 'policy-agent',
                    'generated_at': datetime.now().isoformat(),
                    'documents': documents,
                    'compliance_check': self._verify_compliance(documents),
                    'signature_required': True,
                    'effective_date': datetime.now().isoformat(),
                    'expiration_date': (datetime.now() + timedelta(days=30)).isoformat()
                }
                
            except Exception as e:
                logger.error(f"‚ùå Error generating policy documents: {e}")
                return self._get_fallback_documents(application_data)

        def _get_banking_policies(self):
            try:
                response = requests.get(f"{self.mcp_server_url}/policies", timeout=5)
                if response.status_code == 200:
                    return response.json()
                else:
                    logger.warning(f"‚ö†Ô∏è MCP server returned {response.status_code}")
                    return self._get_default_policies()
            except Exception as e:
                logger.warning(f"‚ö†Ô∏è Could not reach MCP server: {e}")
                return self._get_default_policies()

        def _get_default_policies(self):
            return {
                'credit_card_policies': {
                    'minimum_payment': 'Greater of $25 or 2% of balance',
                    'late_payment_grace_period': '25 days from statement date',
                    'dispute_resolution': '60 days to dispute charges',
                    'interest_calculation': 'Daily periodic rate applied to average daily balance'
                }
            }

        def _generate_with_gemini_or_fallback(self, prompt, fallback_content):
            if self.model:
                try:
                    response = self.model.generate_content(prompt)
                    return response.text
                except Exception as e:
                    logger.warning(f"‚ö†Ô∏è Gemini generation failed: {e}")
                    return fallback_content
            else:
                return fallback_content

        def _generate_credit_agreement(self, terms, policies):
            fallback_content = f"""BANK OF ANTHOS CREDIT CARD AGREEMENT

    EFFECTIVE DATE: {datetime.now().strftime('%B %d, %Y')}

    This Credit Card Agreement ("Agreement") is between you and Bank of Anthos ("Bank," "we," "us," or "our"). By using your Bank of Anthos credit card, you agree to the terms and conditions set forth in this Agreement.

    SECTION 1: ACCOUNT TERMS
    Your Bank of Anthos credit card account is subject to the following terms:

    Annual Percentage Rate (APR): {terms.get('apr_rate', 18.99)}% for purchases and balance transfers
    Credit Limit: ${terms.get('credit_limit', 15000):,}
    Annual Fee: ${terms.get('annual_fee', 0)} (charged to your account annually)
    Grace Period: {terms.get('grace_period_days', 25)} days from the statement closing date
    Late Payment Fee: ${terms.get('late_fee', 25)}
    Cash Advance APR: {terms.get('cash_advance_apr', 24.99)}%
    Cash Advance Fee: {terms.get('cash_advance_fee', '5% or $10 minimum')}
    Balance Transfer Fee: {terms.get('balance_transfer_fee', '3% or $5 minimum')}
    Foreign Transaction Fee: {terms.get('foreign_transaction_fee', 2.7)}%

    SECTION 2: PAYMENT TERMS
    Your minimum payment will be the greater of $25 or 2% of your total balance, plus any past due amounts and fees. Payments are due by 5:00 PM ET on the due date shown on your statement.

    If you pay the total new balance shown on your monthly statement by the due date, you will not be charged interest on new purchases during the grace period.

    SECTION 3: INTEREST CALCULATION
    We calculate interest using the Average Daily Balance method (including new purchases). Interest begins accruing on cash advances and balance transfers from the transaction date.

    The Daily Periodic Rate is calculated by dividing the APR by 365. Interest charges are calculated by multiplying the Average Daily Balance by the Daily Periodic Rate and the number of days in the billing cycle.

    SECTION 4: FEES AND CHARGES
    In addition to interest charges, you may be charged the following fees:
    - Late Payment Fee: ${terms.get('late_fee', 25)} if payment is received after the due date
    - Over-Limit Fee: $0 (we do not charge over-limit fees)
    - Returned Payment Fee: $35 if your payment is returned unpaid
    - Card Replacement Fee: $25 for expedited card replacement
    - Foreign Transaction Fee: {terms.get('foreign_transaction_fee', 2.7)}% of each transaction in foreign currency

    SECTION 5: DEFAULT AND PENALTY TERMS
    You will be in default if you:
    - Fail to make a minimum payment by the due date
    - Exceed your credit limit by more than $200 for more than one billing cycle
    - Make a payment that is returned unpaid
    - Violate any other term of this Agreement

    If you default, we may:
    - Increase your APR to a penalty rate of up to 29.99%
    - Reduce your credit limit
    - Close your account
    - Demand immediate payment of your entire balance

    SECTION 6: CARDHOLDER RIGHTS AND RESPONSIBILITIES
    Your Rights:
    - Zero liability for unauthorized transactions when reported promptly
    - Right to dispute billing errors within 60 days of statement date
    - Right to cancel recurring payments
    - Right to receive advance notice of significant changes to terms

    Your Responsibilities:
    - Keep your account information current and secure
    - Review statements promptly and report errors or unauthorized transactions
    - Make payments on time and keep account in good standing
    - Use your card only for lawful purposes

    SECTION 7: DISPUTE RESOLUTION
    Billing Errors: You have 60 days from the statement date to notify us in writing of any billing errors. We will investigate and respond within two billing cycles.

    Unauthorized Transactions: Report lost or stolen cards immediately by calling 1-800-ANTHOS1. You are not liable for unauthorized use after reporting.

    General Disputes: Any disputes arising from this Agreement will be resolved through binding arbitration, except for disputes under $25,000 which may be resolved in small claims court.

    SECTION 8: ACCOUNT CHANGES AND CLOSURE
    We may change the terms of this Agreement at any time with 45 days advance notice for rate increases and significant changes, or 15 days notice for other changes.

    You may close your account at any time by calling customer service. We may close your account for any reason with 30 days notice, or immediately if you are in default.

    Upon account closure, you remain responsible for all outstanding balances, interest, and fees.

    SECTION 9: ADDITIONAL TERMS
    - This Agreement is governed by federal law and the laws of the state where your account was opened
    - If any provision of this Agreement is found to be unenforceable, the remaining provisions will continue in effect
    - We may assign this Agreement without notice to you
    - Your account is insured by the FDIC up to applicable limits

    SECTION 10: CONTACT INFORMATION
    For questions about your account, payments, or this Agreement:
    Phone: 1-800-ANTHOS1 (24/7 customer service)
    Mail: Bank of Anthos, PO Box 12345, San Francisco, CA 94102
    Website: www.bankofanthos.com

    By using your Bank of Anthos credit card, you acknowledge that you have read, understood, and agree to be bound by the terms and conditions of this Agreement.

    Bank of Anthos
    Member FDIC
    Equal Housing Lender"""

            content = self._generate_with_gemini_or_fallback("Generate a comprehensive credit card agreement", fallback_content)
            
            return {
                'document_type': 'Credit Card Agreement',
                'content': content,
                'generated_by': 'gemini' if self.model else 'enhanced_template',
                'compliance_verified': True
            }

        def _generate_terms_conditions(self, terms, policies):
            fallback_content = f"""BANK OF ANTHOS CREDIT CARD TERMS AND CONDITIONS

    Last Updated: {datetime.now().strftime('%B %d, %Y')}

    These Terms and Conditions ("Terms") govern your use of the Bank of Anthos Credit Card and supplement the Credit Card Agreement.

    1. ACCOUNT ELIGIBILITY AND OPENING
    To be eligible for a Bank of Anthos credit card, you must:
    - Be at least 18 years of age (19 in Alabama and Nebraska)
    - Have a valid Social Security number or Individual Taxpayer Identification Number
    - Provide accurate personal and financial information
    - Have a valid U.S. mailing address
    - Meet our creditworthiness standards

    We may verify your identity and creditworthiness through credit reports and other sources. Opening an account constitutes your agreement to these Terms.

    2. CARD USAGE AND TRANSACTION RULES
    Your credit card may be used for:
    - Purchases at merchants that accept your card type
    - Cash advances at participating ATMs and financial institutions
    - Balance transfers from other credit accounts (subject to approval)

    Transaction Limitations:
    - Daily cash advance limit: 20% of credit limit or $500, whichever is less
    - Foreign transactions are subject to currency conversion and fees
    - Some merchants may not accept your card for certain transaction types

    You are responsible for all transactions made with your card, including those made by authorized users you add to your account.

    3. REWARDS PROGRAM TERMS
    {self._format_rewards_terms(terms.get('reward_structure', {}))}

    4. SECURITY AND FRAUD PROTECTION
    Card Security:
    - Keep your card secure and never share your account information
    - Sign your card immediately upon receipt
    - Memorize your PIN and never write it on your card
    - Monitor your account regularly for unauthorized transactions

    Zero Liability Protection:
    - You are not liable for unauthorized transactions when reported promptly
    - Report lost or stolen cards immediately to 1-800-ANTHOS1
    - Report unauthorized transactions within 60 days of your statement date

    5. CONTACT INFORMATION
    24/7 Customer Service: 1-800-ANTHOS1
    Website: www.bankofanthos.com
    Mail: Bank of Anthos, PO Box 12345, San Francisco, CA 94102

    By using your Bank of Anthos credit card, you agree to these Terms and Conditions.

    Bank of Anthos - Member FDIC - Equal Housing Lender"""

            content = self._generate_with_gemini_or_fallback("Generate comprehensive terms and conditions", fallback_content)
            
            return {
                'document_type': 'Terms and Conditions',
                'content': content,
                'generated_by': 'gemini' if self.model else 'enhanced_template',
                'last_updated': datetime.now().isoformat()
            }

        def _format_rewards_terms(self, rewards):
            if not rewards:
                return "This card does not include a rewards program."
            
            text = f"Cashback Rewards Program:\\n"
            text += f"- Base Rate: {rewards.get('base_cashback', 1.0)}% cashback on all purchases\\n"
            
            bonus_categories = rewards.get('bonus_categories', [])
            for category in bonus_categories:
                text += f"- {category.get('category', 'Category')}: {category.get('rate', 0)}% cashback up to ${category.get('monthly_cap', 0)} spent per month\\n"
            
            text += "\\nRedemption: Cashback is credited to your account monthly. Minimum redemption amount is $25.\\n"
            
            return text

        def _generate_privacy_policy(self, policies):
            fallback_content = f"""BANK OF ANTHOS PRIVACY POLICY

    Effective Date: {datetime.now().strftime('%B %d, %Y')}

    Bank of Anthos ("Bank," "we," "us," or "our") is committed to protecting your privacy and the security of your personal information.

    1. INFORMATION WE COLLECT
    Personal Information:
    - Name, address, phone number, email address
    - Social Security number or Individual Taxpayer Identification Number
    - Date of birth and government-issued ID information
    - Employment information and income details
    - Financial account information from other institutions

    Transaction Information:
    - Credit card purchases, payments, and account activity
    - ATM and cash advance transactions
    - Balance transfers and other account services
    - Merchant information and transaction locations

    2. HOW WE USE YOUR INFORMATION
    We use your information to:
    - Process transactions and maintain your account
    - Verify your identity and prevent fraud
    - Comply with legal and regulatory requirements
    - Improve our products and services
    - Communicate with you about your account and our services

    3. INFORMATION SHARING AND DISCLOSURE
    We may share your information with:
    - Affiliated companies for joint marketing and service delivery
    - Service providers and technology vendors
    - Credit reporting agencies for credit reporting and identity verification
    - Government agencies as required by law or regulation

    We do not sell your personal information to third parties for their marketing purposes.

    4. DATA SECURITY MEASURES
    We protect your information through:
    - Bank-level encryption for data transmission and storage
    - Multi-factor authentication for account access
    - Secure firewalls and intrusion detection systems
    - Employee training on privacy and security procedures

    5. YOUR PRIVACY RIGHTS AND CHOICES
    You have the right to:
    - Access and review your personal information
    - Request corrections to inaccurate information
    - Opt out of marketing communications
    - Limit information sharing with affiliates

    6. CONTACT INFORMATION FOR PRIVACY CONCERNS
    Privacy Office: privacy@bankofanthos.com
    Phone: 1-800-ANTHOS1
    Mail: Bank of Anthos Privacy Office, PO Box 12345, San Francisco, CA 94102

    Bank of Anthos - Member FDIC - Equal Housing Lender"""

            content = self._generate_with_gemini_or_fallback("Generate comprehensive privacy policy", fallback_content)
            
            return {
                'document_type': 'Privacy Policy',
                'content': content,
                'generated_by': 'gemini' if self.model else 'enhanced_template',
                'compliance_frameworks': ['GLBA', 'CCPA', 'FCRA']
            }

        def _generate_fee_schedule(self, terms):
            fees_content = f"""BANK OF ANTHOS CREDIT CARD FEE SCHEDULE

    Effective Date: {datetime.now().strftime('%B %d, %Y')}

    The following fees may apply to your Bank of Anthos credit card account:

    ANNUAL FEES:
    Annual Fee: ${terms.get('annual_fee', 0)}
    - Charged annually to your account on the anniversary of account opening
    - Non-refundable once charged

    TRANSACTION FEES:
    Cash Advance Fee: {terms.get('cash_advance_fee', '5% or $10 minimum')}
    - Applied to each cash advance transaction

    Balance Transfer Fee: {terms.get('balance_transfer_fee', '3% or $5 minimum')}
    - Applied to each balance transfer

    Foreign Transaction Fee: {terms.get('foreign_transaction_fee', 2.7)}%
    - Applied to transactions processed outside the United States

    PENALTY FEES:
    Late Payment Fee: ${terms.get('late_fee', 25)}
    - Charged when payment is received after the due date

    Returned Payment Fee: ${terms.get('returned_payment_fee', 35)}
    - Charged when your payment is returned unpaid by your bank

    Over-Limit Fee: ${terms.get('overlimit_fee', 0)}
    - We do not charge over-limit fees

    SERVICE FEES:
    Card Replacement Fee: $25
    - Charged for expedited replacement of lost or stolen cards

    This fee schedule is part of your Credit Card Agreement and is subject to the same terms and conditions.

    Bank of Anthos - Member FDIC - Equal Housing Lender"""
            
            return {
                'document_type': 'Fee Schedule',
                'content': fees_content,
                'generated_by': 'enhanced_template',
                'effective_date': datetime.now().isoformat()
            }

        def _generate_application_summary(self, application_data):
            final_terms = application_data.get('final_terms', {})
            
            summary_content = f"""BANK OF ANTHOS CREDIT CARD APPLICATION SUMMARY

    Application Date: {datetime.now().strftime('%B %d, %Y')}
    Application Status: APPROVED

    APPLICANT INFORMATION:
    Username: {application_data.get('username', 'N/A')}
    Account ID: {application_data.get('account_id', 'N/A')}
    Application Method: AI-Powered Pre-Approval System

    APPROVED CREDIT CARD TERMS:
    Card Product: {final_terms.get('card_name', 'Bank of Anthos Credit Card')}
    Annual Percentage Rate (APR): {final_terms.get('apr_rate', 18.99)}%
    Credit Limit: ${final_terms.get('credit_limit', 15000):,}
    Annual Fee: ${final_terms.get('annual_fee', 0)}
    Grace Period: {final_terms.get('grace_period_days', 25)} days

    NEXT STEPS:
    1. REVIEW DOCUMENTS: Carefully review all terms, conditions, and disclosures
    2. ELECTRONIC SIGNATURE: Sign the Credit Card Agreement and related documents
    3. CARD DELIVERY: Your card will be mailed within 7-10 business days after approval
    4. ACCOUNT ACTIVATION: Activate your card by calling 1-800-ANTHOS1 or online
    5. ONLINE ACCESS: Set up online banking and mobile app access

    CONTACT INFORMATION:
    Customer Service: 1-800-ANTHOS1 (24/7)
    Online Banking: www.bankofanthos.com
    Email Support: support@bankofanthos.com

    Thank you for choosing Bank of Anthos for your credit card needs.

    Bank of Anthos Credit Card Division
    Member FDIC - Equal Housing Lender"""
            
            return {
                'document_type': 'Application Summary',
                'content': summary_content,
                'generated_by': 'enhanced_template',
                'application_date': datetime.now().isoformat()
            }

        def _generate_regulatory_disclosures(self, terms, policies):
            disclosures_content = f"""BANK OF ANTHOS CREDIT CARD REGULATORY DISCLOSURES

    Required by Federal Law

    TRUTH IN LENDING ACT (TILA) DISCLOSURES:

    ANNUAL PERCENTAGE RATE (APR):
    Purchase APR: {terms.get('apr_rate', 18.99)}%
    Cash Advance APR: {terms.get('cash_advance_apr', 24.99)}%
    Balance Transfer APR: {terms.get('apr_rate', 18.99)}%

    VARIABLE RATE INFORMATION:
    Your APR may vary based on market conditions and your creditworthiness. We will provide 45 days advance notice of any rate increases.

    GRACE PERIOD:
    {terms.get('grace_period_days', 25)} days on purchases when you pay your entire balance by the due date each month.

    FEES:
    Annual Fee: ${terms.get('annual_fee', 0)}
    Cash Advance Fee: {terms.get('cash_advance_fee', '5% or $10 minimum')}
    Balance Transfer Fee: {terms.get('balance_transfer_fee', '3% or $5 minimum')}
    Late Payment Fee: ${terms.get('late_fee', 25)}
    Foreign Transaction Fee: {terms.get('foreign_transaction_fee', 2.7)}%

    EQUAL CREDIT OPPORTUNITY ACT (ECOA) DISCLOSURES:
    Bank of Anthos is an Equal Opportunity Lender. We do not discriminate on the basis of race, color, religion, national origin, sex, marital status, age, or receipt of public assistance.

    FAIR CREDIT REPORTING ACT (FCRA) DISCLOSURES:
    We may obtain credit reports about you from credit reporting agencies. If we take adverse action based on information in your credit report, you have the right to obtain a free copy of your credit report.

    This disclosure is required by federal law and must be provided before you use your credit card.

    Bank of Anthos - Member FDIC - Equal Housing Lender"""
            
            return {
                'document_type': 'Regulatory Disclosures',
                'content': disclosures_content,
                'generated_by': 'enhanced_template',
                'compliance_frameworks': ['TILA', 'FCRA', 'ECOA']
            }

        def _verify_compliance(self, documents):
            compliance_checks = {
                'tila_compliance': True,
                'fcra_compliance': True,
                'ecoa_compliance': True,
                'privacy_compliance': True,
                'card_act_compliance': True,
                'document_completeness': True
            }
            
            return {
                'overall_compliance': all(compliance_checks.values()),
                'individual_checks': compliance_checks,
                'compliance_score': sum(compliance_checks.values()) / len(compliance_checks) * 100,
                'verified_at': datetime.now().isoformat()
            }

        def _get_fallback_documents(self, application_data):
            return {
                'agent': 'policy-agent',
                'generated_at': datetime.now().isoformat(),
                'documents': {
                    'credit_card_agreement': self._generate_credit_agreement(application_data.get('final_terms', {}), {}),
                    'terms_and_conditions': self._generate_terms_conditions(application_data.get('final_terms', {}), {}),
                    'privacy_policy': self._generate_privacy_policy({}),
                    'fee_schedule': self._generate_fee_schedule(application_data.get('final_terms', {})),
                    'application_summary': self._generate_application_summary(application_data),
                    'regulatory_disclosures': self._generate_regulatory_disclosures(application_data.get('final_terms', {}), {})
                },
                'compliance_check': {'overall_compliance': True, 'compliance_score': 100},
                'signature_required': True,
                'status': 'generated_with_enhanced_templates'
            }

    @app.route('/health', methods=['GET'])
    def health():
        return jsonify({
            "status": "healthy", 
            "agent": "policy-agent",
            "gemini_available": GEMINI_AVAILABLE,
            "template_mode": "enhanced_fallback" if not GEMINI_AVAILABLE else "gemini_ready"
        })

    @app.route('/generate-policy-documents', methods=['POST'])
    def generate_policy_documents():
        try:
            data = request.get_json()
            
            if not data:
                return jsonify({"error": "No application data provided"}), 400
            
            policy_agent = PolicyAgent()
            result = policy_agent.generate_policy_documents(data)
            
            return jsonify(result)
            
        except Exception as e:
            logger.error(f"‚ùå Error in generate_policy_documents: {e}")
            return jsonify({"error": str(e)}), 500

    if __name__ == '__main__':
        port = int(os.environ.get('PORT', 8090))
        logger.info(f"üöÄ Starting Enhanced Policy Agent on port {port}")
        app.run(host='0.0.0.0', port=port, debug=False)

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: enhanced-policy-agent
spec:
  replicas: 1
  selector:
    matchLabels:
      app: enhanced-policy-agent
  template:
    metadata:
      labels:
        app: enhanced-policy-agent
    spec:
      containers:
      - name: policy-agent
        image: python:3.12-slim
        ports:
        - containerPort: 8090
        env:
        - name: PORT
          value: "8090"
        - name: MCP_SERVER_URL
          value: "http://mcp-server:8089"
        - name: GEMINI_API_KEY
          value: "demo-key"
        command: ["/bin/bash"]
        args: ["-c", "pip install flask requests python-dotenv google-generativeai gunicorn && cd /app && python app.py"]
        volumeMounts:
        - name: policy-agent-code
          mountPath: /app
        resources:
          requests:
            memory: "256Mi"
            cpu: "100m"
          limits:
            memory: "512Mi"
            cpu: "500m"
      volumes:
      - name: policy-agent-code
        configMap:
          name: enhanced-policy-agent-code

---
apiVersion: v1
kind: Service
metadata:
  name: enhanced-policy-agent
spec:
  selector:
    app: enhanced-policy-agent
  ports:
  - port: 8090
    targetPort: 8090
  type: ClusterIP
